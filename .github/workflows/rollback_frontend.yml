name: Frontend Rollback

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'The version/tag to rollback to (e.g., v1.0.1)'
        required: true

jobs:
  rollback:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # CHECK IF FILES EXIST IN LIVE BUCKET
      - name: Check for existing files
        id: check_files
        run: |
          if aws s3 ls "s3://${{ secrets.LIVE_FRONTEND_BUCKET_NAME }}/${{ github.event.inputs.version }}/" > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      # RESTORE FROM ARTIFACT BUCKET (If missing from Live)
      - name: Restore from Artifacts
        if: steps.check_files.outputs.exists == 'false'
        run: |
          echo "Version not found in Live bucket. Restoring from Artifacts..."
          aws s3 cp s3://${{ secrets.S3_BUCKET_NAME }}/artifacts/frontend-${{ github.event.inputs.version }}.tar.gz .
          mkdir restore_dir
          tar -xzf frontend-${{ github.event.inputs.version }}.tar.gz -C restore_dir
          aws s3 sync restore_dir s3://${{ secrets.LIVE_FRONTEND_BUCKET_NAME }}/${{ github.event.inputs.version }} --delete

      # UPDATE CLOUDFRONT ORIGIN PATH
      - name: Point CloudFront to Rollback Version
        run: |
          aws cloudfront get-distribution-config --id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} > config.json
          ETAG=$(jq -r '.ETag' config.json)
     
          # Update OriginPath to the target version folder
          jq '.DistributionConfig.Origins.Items[0].OriginPath = "/${{ github.event.inputs.version }}"' config.json > updated_config.json

          aws cloudfront update-distribution \
            --id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --if-match $ETAG \
            --distribution-config file://updated_config.json

      # INVALIDATE CACHE
      - name: Invalidate CloudFront Cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"

      - name: Success Message
        run: echo "Successfully rolled back to version ${{ github.event.inputs.version }}"